<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Document</title>
</head>

<body>
  <script>
  var setItem = function(key, value) {
    value = JSON.stringify(value);
    window.localStorage.setItem(key, value);
  };
  var removeItem = function() {

  };

  var util = {

    insert: function(obj) {
      var _this = this;
      return new Promise(function(resolve, reject) {
        obj['_id'] = new Date().getTime();
        _this.data.push(obj);
        setItem('MS-' + _this.key, _this.data);
        resolve(obj);
      });
    },

    /**
     * Find
     * @param  {[type]} obj [description]
     * @return {[type]}     [description]
     */
    find: function(query) {
      var _this = this;
      var args = arguments;
      var result = [];

      return new Promise(function(resolve, reject) {
        if (args.length == 0) {
          result = _this.data;
        }
        for (var key in query) {
          _this.data.forEach(function(item) {
            if (item[key] == query[key]) {
              result.push(item);
            }
          });
        }
        resolve(result);
      });
    },

    update: function(query, update, options) {

    },

    /**
     * 删除doc
     * @param  {[type]} obj [description]
     * @return {[type]}     [description]
     */
    delete: function(obj) {
      var _this = this;
      var args = arguments;
      return new Promise(function(resolve, reject) {
        if (args.length == 0) {
          resolve(_this.data);
          return false;
        }
        if (typeof obj === "object" && (obj !== null)) {
          obj = [obj];
        }
        obj.forEach(function(item) {
          var index = _this.data.indexOf(item);
          index != -1 ? _this.data.splice(index, 1) : '';
        });
        setItem(key, _this.data);
        resolve(_this.data);
      });
    },

    remove: function() {
      delete db[this.key];
      localStorage.removeItem('MS-' + this.key);
    }
  };

  function MStorage() {
    this.collectionMap = {};
    this.nameList = [];


    var storages = window.localStorage;
    for (var key in storages) {
      // 过滤掉不是MStorage 创建的key
      if (/^MS\-/.test(key)) {
        key = key.slice(3);
        this.nameList.push(key);
        this.collectionMap[key] = storages['MS-' + key];
        this[key] = Object.create(util);
        this[key].data = JSON.parse(storages['MS-' + key]);
        this[key].key = key;
      }
    }




  }

  /**
   * show All collections
   * @return {Array} name of collections
   */
  MStorage.prototype.showCollections = function() {
    var storages = window.localStorage;
    var result = [];
    for (var key in storages) {
      if (/^MS\-/.test(key)) {
        result.push(key);
      }
    }
    return result;
  };

  /**
   * create collection
   * @param  {[type]} collection [description]
   * @return {[type]}            [description]
   */
  MStorage.prototype.create = function(collection) {
    collection = collection ? collection : 'default';
    if (this.collectionMap[collection] !== undefined) {
      console.warn('key named "%s" has already exist...', collection);
      return false;
    }
    this.nameList.push(collection);
    this.collectionMap[collection] = [];
    this[collection] = Object.create(util);
    this[collection].data = [];
    this[collection].key = collection;
    setItem('MS-' + collection, []);
  };

  var db = new MStorage();
  </script>
</body>

</html>
